---
import { type CollectionEntry } from 'astro:content'

import { getBlogCollection } from 'astro-pure/server'
import { cn } from 'astro-pure/utils'

export const prerender = true
export const partial = true

const docsCollection = (await getBlogCollection('docs')) as CollectionEntry<'docs'>[]

// Group docs by technical field
const docsByField = docsCollection.reduce((acc: { [key: string]: typeof docsCollection }, doc) => {
  const id = doc.id.split('/')[0]
  const subId = doc.id.split('/')[1]
  
  // Determine the technical field
  let field = 'other'
  if (id === 'interview') {
    field = 'interview'
  } else if (id === 'showcase') {
    field = 'showcase'
  } else if (id === 'learning') {
    if (subId === 'ai-fullstack' || subId === 'llm') {
      field = 'ai-fullstack'
    } else if (subId === 'algorithm') {
      field = 'algorithm'
    } else if (subId === 'frontend-deep') {
      field = 'frontend'
    } else if (subId === 'game-deep') {
      field = 'game'
    }
  }
  
  if (!acc[field]) acc[field] = [] as typeof docsCollection
  acc[field].push(doc)
  return acc
}, {})

const docCategories = {
  'ai-fullstack': 'AI 全栈',
  algorithm: '算法',
  frontend: '前端开发',
  game: '游戏开发',
  interview: '面试题库',
  showcase: '项目展示'
}

type Props = {
  title?: boolean
  class?: string
}

const { title = true, class: className, ...props } = Astro.props
---

<docs-toc class={cn('not-prose', className)} {...props}>
  {title && <h2 class='text-foreground font-medium'>DOCS</h2>}
  <ul class='mt-4 flex flex-col gap-y-5'>
    {
      Object.entries(docCategories).map(([id, title]: [string, string]) => (
        <li>
          <h3 class='text-muted-foreground text-xs tracking-widest uppercase'>{title}</h3>
          <ul class='mt-2 flex flex-col'>
            {docsByField[id]
              ?.sort((a, b) => {
                // 优先按数字编号排序（从标题中提取数字）
                const getNumber = (title: string) => {
                  const match = title.match(/^(\d+)([-.])/)
                  return match ? parseInt(match[1], 10) : 999
                }
                
                const numA = getNumber(a.data.title)
                const numB = getNumber(b.data.title)
                
                if (numA !== numB) {
                  return numA - numB
                }
                
                // 如果编号相同，按标题排序
                return a.data.title.localeCompare(b.data.title)
              })
              .map((doc) => (
                <li class='docs-item flex relative ms-2 px-3 py-1 text-foreground/75 transition-all rounded-2xl'>
                  <a class='flex-1 hover:text-foreground' href={`/docs/${doc.id}`}>
                    {doc.data.title}
                  </a>
                </li>
              ))}
          </ul>
        </li>
      ))
    }
  </ul>
</docs-toc>

<style>
  docs-toc .docs-item::before {
    content: '';
    display: block;
    position: absolute;
    top: 5%;
    bottom: 5%;
    left: -0.5rem;
    width: 2px;
    background-color: hsl(var(--input) / var(--un-bg-opacity));
  }

  docs-toc :global(.docs-item.docs-hl) {
    background-color: hsl(var(--muted) / var(--un-bg-opacity));
    font-weight: 500;
    & a {
      color: hsl(var(--primary) / var(--un-text-opacity));
    }

    &::before {
      background-color: hsl(var(--primary) / var(--un-bg-opacity));
    }
  }
</style>

<script>
  class DocsTOC extends HTMLElement {
    link: string = ''

    constructor() {
      super()
      this.link = window.location.pathname
    }

    connectedCallback() {
      const links = this.querySelectorAll('a')
      links.forEach((link) => {
        if (link.getAttribute('href') === this.link) {
          link.parentElement?.classList.add('docs-hl')
        }
      })
    }
  }

  customElements.define('docs-toc', DocsTOC)
</script>
