---
import Layout from '@/layouts/Layout.astro';
import { getCollection } from 'astro:content';
import Card from '@/components/Card.astro';
import Section from '@/components/Section.astro';
import { AppConfig } from '@/utils/AppConfig';

const POSTS_PER_PAGE = 4;

// Generate static paths for category pagination
export async function getStaticPaths() {
  const POSTS_PER_PAGE = 4;

  const allPosts = (await getCollection('blog'))
    .filter(post => !post.data.draft)
    .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

  // Get unique categories
  const categories = Array.from(
    new Set(allPosts.map(post => post.data.category).filter(Boolean))
  ).sort();

  const paths = [];

  // Generate paths for each category and each page (excluding page 1)
  for (const cat of categories) {
    const categoryPosts = allPosts.filter(post => post.data.category === cat);
    const totalPages = Math.ceil(categoryPosts.length / POSTS_PER_PAGE);

    for (let page = 2; page <= totalPages; page++) {
      paths.push({
        params: {
          category: encodeURIComponent(cat || ''),
          page: page.toString()
        }
      });
    }
  }

  return paths;
}

// Get category and page from URL params
const { category, page } = Astro.params;
const decodedCategory = decodeURIComponent(category || '');
const currentPage = parseInt(page || '1', 10);

// Get all posts
const allPosts = (await getCollection('blog'))
  .filter(post => !post.data.draft)
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

// Get unique categories
const categories = Array.from(
  new Set(allPosts.map(post => post.data.category).filter(Boolean))
).sort();

// Filter posts by category
const filteredPosts = allPosts.filter(post => post.data.category === decodedCategory);

// Calculate pagination
const totalPages = Math.ceil(filteredPosts.length / POSTS_PER_PAGE);
const startIndex = (currentPage - 1) * POSTS_PER_PAGE;
const endIndex = startIndex + POSTS_PER_PAGE;
const currentPosts = filteredPosts.slice(startIndex, endIndex);

// Generate page numbers to show
function getVisiblePages(current: number, total: number) {
  const pages: number[] = [];
  
  if (total <= 7) {
    for (let i = 1; i <= total; i++) {
      pages.push(i);
    }
  } else {
    pages.push(1);
    if (current > 3) {
      pages.push(-1);
    }
    const start = Math.max(2, current - 1);
    const end = Math.min(total - 1, current + 1);
    for (let i = start; i <= end; i++) {
      pages.push(i);
    }
    if (current < total - 2) {
      pages.push(-1);
    }
    pages.push(total);
  }
  
  return pages;
}

const visiblePages = getVisiblePages(currentPage, totalPages);
---

<Layout
  head={{
    title: `${decodedCategory} - ${AppConfig.title}`,
    description: AppConfig.description
  }}
>
  <Section>
    <div class="py-12">
      <h1 class="mb-8 text-4xl font-bold">
        {decodedCategory} Posts
      </h1>
      <p class="mb-12 text-lg text-gray-600 dark:text-gray-400">
        Showing {startIndex + 1}-{Math.min(endIndex, filteredPosts.length)} of {filteredPosts.length} posts in {decodedCategory}
      </p>

      <!-- Category Filter -->
      <div class="mb-8 flex flex-wrap gap-2">
        <a
          href="/blog/"
          class="rounded-full bg-stone-200 px-4 py-2 text-sm font-semibold text-stone-800 hover:bg-stone-300 dark:bg-stone-700 dark:text-stone-200 dark:hover:bg-stone-600"
        >
          All
        </a>
        {categories.map((cat) => (
          <a
            href={`/blog/category/${encodeURIComponent(cat || '')}`}
            class:font-bold={cat === decodedCategory}
            class="rounded-full bg-stone-200 px-4 py-2 text-sm font-semibold text-stone-800 hover:bg-stone-300 dark:bg-stone-700 dark:text-stone-200 dark:hover:bg-stone-600"
          >
            {cat}
          </a>
        ))}
      </div>

      <!-- Posts Grid - 2x2 layout -->
      <div class="grid grid-cols-1 gap-6 md:grid-cols-2 mb-12">
        {currentPosts.map((post) => (
          <div>
            <Card post={post} />
          </div>
        ))}
      </div>

      <!-- Pagination -->
      {totalPages > 1 && (
        <div class="flex justify-center items-center gap-2">
          {currentPage > 1 && (
            <a
              href={currentPage === 2 
                ? `/blog/category/${encodeURIComponent(category || '')}/` 
                : `/blog/category/${encodeURIComponent(category || '')}/${currentPage - 1}`}
              class="rounded-lg bg-stone-200 px-4 py-2 text-sm font-semibold text-stone-800 hover:bg-stone-300 dark:bg-stone-700 dark:text-stone-200 dark:hover:bg-stone-600"
            >
              ← Previous
            </a>
          )}

          {visiblePages.map((pageNum) => {
            if (pageNum === -1) {
              return <span class="text-gray-500">...</span>;
            }

            return (
              <a
                href={pageNum === 1 
                  ? `/blog/category/${encodeURIComponent(category || '')}/` 
                  : `/blog/category/${encodeURIComponent(category || '')}/${pageNum}`}
                class:font-bold={pageNum === currentPage}
                class={`rounded-lg px-4 py-2 text-sm font-semibold ${
                  pageNum === currentPage
                    ? 'bg-stone-900 text-stone-100 dark:bg-stone-100 dark:text-stone-900'
                    : 'bg-stone-200 text-stone-800 hover:bg-stone-300 dark:bg-stone-700 dark:text-stone-200 dark:hover:bg-stone-600'
                }`}
              >
                {pageNum}
              </a>
            );
          })}

          {currentPage < totalPages && (
            <a
              href={`/blog/category/${encodeURIComponent(category || '')}/${currentPage + 1}`}
              class="rounded-lg bg-stone-200 px-4 py-2 text-sm font-semibold text-stone-800 hover:bg-stone-300 dark:bg-stone-700 dark:text-stone-200 dark:hover:bg-stone-600"
            >
              Next →
            </a>
          )}
        </div>
      )}
    </div>
  </Section>
</Layout>