import{_ as e}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as l,o as r,e as a}from"./app-DnslNVmo.js";const d={};function o(h,i){return r(),l("div",null,[...i[0]||(i[0]=[a('<h1 id="thingsboard-基于-mqtt-的-rpc-协议" tabindex="-1"><a class="header-anchor" href="#thingsboard-基于-mqtt-的-rpc-协议" aria-hidden="true">#</a> ThingsBoard 基于 MQTT 的 RPC 协议</h1><h2 id="什么是-mqtt" tabindex="-1"><a class="header-anchor" href="#什么是-mqtt" aria-hidden="true">#</a> 什么是 MQTT</h2><ol><li>MQTT 是一个基于客户端-服务器的消息发布/订阅传输协议。</li><li>MQTT 协议是轻量、简单、开放和易于实现的，这些特点使它适用范围非常广泛。</li><li>在很多情况下，包括受限的环境中，如：机器与机器（M2M）通信和物联网（IoT）。</li><li>其在，通过卫星链路通信传感器、偶尔拨号的医疗设备、智能家居、及一些小型化设备中已广泛使用。</li></ol><h3 id="设计规范" tabindex="-1"><a class="header-anchor" href="#设计规范" aria-hidden="true">#</a> 设计规范</h3><ol><li>精简，不添加可有可无的功能；</li><li>发布/订阅（Pub/Sub）模式，方便消息在传感器之间传递；</li><li>允许用户动态创建主题，零运维成本；</li><li>把传输量降到最低以提高传输效率；</li><li>把低带宽、高延迟、不稳定的网络等因素考虑在内；</li><li>支持连续的会话控制；</li><li>理解客户端计算能力可能很低；</li><li>提供服务质量管理；</li><li>假设数据不可知，不强求传输数据的类型与格式，保持灵活性。</li></ol><h2 id="rpc-是什么" tabindex="-1"><a class="header-anchor" href="#rpc-是什么" aria-hidden="true">#</a> RPC 是什么？</h2><p>RPC（Remote Procedure Call）远程过程调用协议，一种通过网络从远程计算机上请求服务，而不需要了解底层网络技术的协议。</p><p>RPC 它假定某些协议的存在，例如 TPC/UDP 等，为通信程序之间携带信息数据。</p><p>在 OSI 网络七层模型中，RPC 跨越了传输层和应用层，RPC 使得开发，包括网络分布式多程序在内的应用程序更加容易。</p><h3 id="rpc-的原理解释" tabindex="-1"><a class="header-anchor" href="#rpc-的原理解释" aria-hidden="true">#</a> RPC 的原理解释</h3><p>RPC 的实现步骤：</p><ol><li>存在两台计算机 A 和 B；</li><li>计算机 A 上的进程，调用另外一台计算机 B 上的进程；</li><li>此时 A 上的调用进程被挂起，而 B 上的被调用进程开始执行并回调计算出的结果；</li><li>当 A 接收到返回的结果后，A 上被挂起的进程才能继续执行。</li></ol><p><a href="./images/RPC%E6%A8%A1%E5%BC%8F%E5%8E%9F%E7%90%86.png" title="RPC模式原理">RPC 模式原理</a></p><h3 id="thingsboard-中-mqtt-的角色" tabindex="-1"><a class="header-anchor" href="#thingsboard-中-mqtt-的角色" aria-hidden="true">#</a> ThingsBoard 中 MQTT 的角色</h3><ul><li><p>ThingsBoard 是 MQTT 服务器</p><ul><li>MQTT 服务器以称为&quot;消息代理&quot;（Broker），可以是一个应用程序或一台设备。</li></ul></li><li><p>数据遥测场景</p><ul><li>发布主题（Topic）为<code>v1/devices/me/telemetry</code></li><li>发布者（Publish）是已注册的设备</li><li>订阅者（Subscribe）是 ThingsBoard 服务</li></ul></li><li><p>指令下发场景</p><ul><li>RPC： <ul><li>订阅主题（Topic）为<code>v1/devices/me/rpc/request/+</code>（主题通配符&quot;+&quot;）</li><li>回复主题（Topic）为<code>v1/devices/me/rpc/response/</code> + requestId</li><li>发布者（Publish）是 ThingsBoard 服务中提供的由 MQTT 封装的 RPC 请求 API</li><li>订阅者（Subscribe）是已注册的设备</li></ul></li><li>MQTT： <ul><li>订阅主题（Topic）为<code>v1/devices/me/attributes</code></li><li>发布者（Publish）是 ThingsBoard 服务中提供的是 MQTT 的共享属性（具有单向下发的特性）</li><li>订阅者（Subscribe）是已注册的设备</li></ul></li></ul></li></ul><h3 id="thingsboard-中-rpc-的应用" tabindex="-1"><a class="header-anchor" href="#thingsboard-中-rpc-的应用" aria-hidden="true">#</a> ThingsBoard 中 RPC 的应用</h3><ol><li>通过 ThingsBoard 封装的 RPC 请求<code>http(s)://host:port/api/plugins/rpc/{callType}/{deviceId}</code>，向指定的设备发送组装好的服务端 MQTT 消息</li><li>设备订阅 rpc 的主题<code>client.subscribe(&#39;v1/devices/me/rpc/request/+&#39;)</code></li><li>消息中包含对应设备 ID 通过 MQTT 协议，发送给指定设备并且带有消息的 ID<code>requestId</code>，解析 MQTT 消息，发送给指定的函数</li><li>处理 MQTT 消息中的参数信息，计算结果通过 MQTT 的 RPC 回调主题+消息的 ID<code>v1/devices/me/rpc/response/${requestId}</code>，将结果发送给服务端，完成调用流程</li></ol><h4 id="thingsboard-中-rpc-存在的问题" tabindex="-1"><a class="header-anchor" href="#thingsboard-中-rpc-存在的问题" aria-hidden="true">#</a> ThingsBoard 中 RPC 存在的问题</h4><ol><li>ThingsBoard 封装的 RPC 的 API 请求，在设备不在线的情况容易出错，并不能主动还原</li><li>一段时间后再次发起 RPC 的 API 请求，还是不能还原</li><li>暂时必须重启 ThingsBoard 服务，才能正常发起 RPC 的 API 请求</li></ol><h4 id="thingsboard-规则链-rpc-发生器" tabindex="-1"><a class="header-anchor" href="#thingsboard-规则链-rpc-发生器" aria-hidden="true">#</a> ThingsBoard 规则链 RPC 发生器</h4><ol><li>利用 generater 发生器，设计一个 RPC 定时请求数据的脚本</li><li>发生器上的<code>period in second</code>就是发生器的触发周期，目前设计的是 12 个小时触发一次，也就是 <code>43200</code> 秒</li><li>发生器上可以选择控制或者请求指定的设备</li><li>利用 ThingsBoard 内部的 MQTT RPC 主题发出消息，向指定的设备请求数据，这里并不会产生 API 错误</li></ol><h4 id="thingsboard-利用共享属性实现单向下发控制指令" tabindex="-1"><a class="header-anchor" href="#thingsboard-利用共享属性实现单向下发控制指令" aria-hidden="true">#</a> ThingsBoard 利用共享属性实现单向下发控制指令</h4><ol><li>设备端订阅属性主题</li><li>当共享属性参数并且改变参数的值，设备端通过监听主题获取参数的值的变化</li><li>触发设备端相应的控制函数，实现控制设备数据在遥测主题下发送</li></ol>',23)])])}const t=e(d,[["render",o],["__file","基于MQTT的RPC协议.html.vue"]]);export{t as default};
