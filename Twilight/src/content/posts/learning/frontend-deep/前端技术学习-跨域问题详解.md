---
title: '前端技术学习 - 跨域问题详解（2025版）'
description: '**同源定义**：协议、域名、端口都相同'
published: 2025-01-02
updatedDate: 2025-01-02
category: '未分类'
tags: []
draft: false
---


# 前端技术学习 - 跨域问题详解（2025版）

## 什么是跨域？

### 同源策略

**同源定义**：协议、域名、端口都相同

| URL | 与 `http://example.com:80` 比较 | 结果 |
|-----|--------------------------------|------|
| `http://example.com:80/page1` | 协议、域名、端口相同 | ✅ 同源 |
| `https://example.com:80/page1` | 协议不同 | ❌ 跨域 |
| `http://example.com:8080/page1` | 端口不同 | ❌ 跨域 |
| `http://other.com:80/page1` | 域名不同 | ❌ 跨域 |

### 跨域场景

1. **AJAX 请求**
```javascript
// 跨域请求
fetch('http://api.example.com/data');
```

2. **WebSocket**
```javascript
// 跨域连接
const ws = new WebSocket('ws://example.com');
```

3. **Canvas**
```javascript
// 跨域图片污染 Canvas
ctx.drawImage(img, 0, 0);
```

## CORS（跨域资源共享）

### 工作原理

```
客户端                    服务器
  |                         |
  |--- OPTIONS /api/data -->|
  |                         |
  |<-- 204 No Content ------|
  |                         |
  |--- POST /api/data ----->|
  |                         |
  |<-- 200 OK --------------|
```

### 服务器配置

#### Node.js

```javascript
const express = require('express');
const cors = require('cors');

const app = express();

// 基本配置
app.use(cors());

// 详细配置
app.use(cors({
  origin: 'http://localhost:3000',
  methods: ['GET', 'POST', 'PUT', 'DELETE'],
  allowedHeaders: ['Content-Type', 'Authorization'],
  credentials: true
}));

app.listen(3000);
```

#### Nginx

```nginx
server {
    listen 80;
    server_name api.example.com;

    location / {
        add_header Access-Control-Allow-Origin http://localhost:3000;
        add_header Access-Control-Allow-Methods 'GET, POST, PUT, DELETE, OPTIONS';
        add_header Access-Control-Allow-Headers 'Content-Type, Authorization';
        add_header Access-Control-Allow-Credentials true;
        
        if ($request_method = 'OPTIONS') {
            return 204;
        }
        
        proxy_pass http://backend;
    }
}
```

### 客户端配置

```javascript
fetch('http://api.example.com/data', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json'
  },
  credentials: 'include'
});
```

## JSONP（已废弃）

### 工作原理

```javascript
// 客户端
function handleResponse(data) {
  console.log(data);
}

const script = document.createElement('script');
script.src = 'http://api.example.com/data?callback=handleResponse';
document.body.appendChild(script);
```

### 服务器端

```javascript
app.get('/data', (req, res) => {
  const callback = req.query.callback;
  const data = { name: 'John' };
  res.send(`${callback}(${JSON.stringify(data)})`);
});
```

**注意**：JSONP 只支持 GET 请求，且存在安全风险，已被废弃。

## 代理

### 开发环境代理

#### Webpack Dev Server

```javascript
// webpack.config.js
module.exports = {
  devServer: {
    proxy: {
      '/api': {
        target: 'http://api.example.com',
        changeOrigin: true,
        pathRewrite: {
          '^/api': ''
        }
      }
    }
  }
};
```

#### Vite

```javascript
// vite.config.js
export default {
  server: {
    proxy: {
      '/api': {
        target: 'http://api.example.com',
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/api/, '')
      }
    }
  }
};
```

### Nginx 反向代理

```nginx
server {
    listen 80;
    server_name frontend.example.com;

    location /api/ {
        proxy_pass http://api.example.com/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

## WebSocket 跨域

### 配置

```javascript
// 客户端
const ws = new WebSocket('ws://example.com');

ws.onopen = () => {
  console.log('连接成功');
};

ws.onmessage = (event) => {
  console.log('收到消息:', event.data);
};
```

### 服务器配置

```javascript
const WebSocket = require('ws');

const wss = new WebSocket.Server({
  port: 8080,
  origin: 'http://localhost:3000'
});

wss.on('connection', (ws) => {
  ws.send('欢迎连接');
});
```

## postMessage 跨域

### 跨窗口通信

```javascript
// 窗口 A
const popup = window.open('http://other.com', 'popup');

popup.postMessage('Hello', 'http://other.com');

window.addEventListener('message', (event) => {
  console.log('收到消息:', event.data);
});

// 窗口 B
window.addEventListener('message', (event) => {
  if (event.origin === 'http://example.com') {
    console.log('收到消息:', event.data);
    event.source.postMessage('Hi', event.origin);
  }
});
```

### iframe 通信

```javascript
// 父页面
const iframe = document.querySelector('iframe');

iframe.contentWindow.postMessage('Hello', 'http://other.com');

// iframe 子页面
window.addEventListener('message', (event) => {
  if (event.origin === 'http://example.com') {
    console.log('收到消息:', event.data);
  }
});
```

## 2025 年最佳实践

### 1. 优先使用 CORS

```javascript
// 推荐：使用 CORS
fetch('http://api.example.com/data', {
  headers: {
    'Content-Type': 'application/json'
  }
});
```

### 2. 开发环境使用代理

```javascript
// 开发环境
const API_URL = '/api';

// 生产环境
const API_URL = 'http://api.example.com';
```

### 3. 使用环境变量

```javascript
const API_BASE_URL = import.meta.env.VITE_API_BASE_URL;

fetch(`${API_BASE_URL}/data`);
```

### 4. 配置正确的 CORS

```javascript
// 服务器端
app.use(cors({
  origin: process.env.ALLOWED_ORIGINS.split(','),
  credentials: true
}));
```

## 常见问题

### 1. 预检请求失败

**问题**：OPTIONS 请求返回 404 或 403

**解决**：确保服务器正确处理 OPTIONS 请求

### 2. Cookie 不发送

**问题**：请求没有携带 Cookie

**解决**：
```javascript
fetch('http://api.example.com/data', {
  credentials: 'include'
});
```

### 3. Access-Control-Allow-Origin 为 *

**问题**：携带凭证时不能使用通配符

**解决**：
```javascript
app.use(cors({
  origin: 'http://localhost:3000',
  credentials: true
}));
```

## 总结

跨域是前端开发中的常见问题，有多种解决方案：

1. **CORS**：现代标准的跨域解决方案
2. **代理**：开发环境的解决方案
3. **WebSocket**：支持跨域
4. **postMessage**：跨窗口通信

**最佳实践**：
1. 生产环境使用 CORS
2. 开发环境使用代理
3. 避免使用 JSONP
4. 注意安全性

## 参考资源

- [MDN - CORS](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/CORS)
- [Web.dev - CORS](https://web.dev/cross-origin-resource-sharing/)
- [Nginx CORS](https://enable-cors.org/server_nginx.html)