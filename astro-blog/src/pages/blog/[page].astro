---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';
import Card from '../../components/Card.astro';
import Section from '../../components/Section.astro';
import { AppConfig } from '../../utils/AppConfig';

const POSTS_PER_PAGE = 4;

// Generate static paths for pagination
export async function getStaticPaths() {
  const POSTS_PER_PAGE = 4;

  const allPosts = (await getCollection('blog'))
    .filter(post => !post.data.draft)
    .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

  const totalPages = Math.ceil(allPosts.length / POSTS_PER_PAGE);

  // Generate paths for pages 2 to totalPages (page 1 is handled by index.astro)
  const paths = [];
  for (let page = 2; page <= totalPages; page++) {
    paths.push({ params: { page: page.toString() } });
  }

  return paths;
}

// Get page number from URL
const { page } = Astro.params;
const currentPage = parseInt(page || '1', 10);

// Redirect page 1 to /blog/
if (currentPage === 1) {
  return Astro.redirect('/blog/');
}

// Validate page number
if (isNaN(currentPage) || currentPage < 1) {
  return Astro.redirect('/blog/');
}

const allPosts = (await getCollection('blog'))
  .filter(post => !post.data.draft)
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

// Get unique categories
const categories = Array.from(
  new Set(allPosts.map(post => post.data.category).filter(Boolean))
).sort();

// Get current category from URL params
const url = new URL(Astro.url);
const categoryParam = url.searchParams.get('category');
const currentCategory = categoryParam ? decodeURIComponent(categoryParam) : null;

// Filter posts by category
const filteredPosts = currentCategory
  ? allPosts.filter(post => post.data.category === currentCategory)
  : allPosts;

// Calculate pagination
const totalPages = Math.ceil(filteredPosts.length / POSTS_PER_PAGE);
const startIndex = (currentPage - 1) * POSTS_PER_PAGE;
const endIndex = startIndex + POSTS_PER_PAGE;
const currentPosts = filteredPosts.slice(startIndex, endIndex);

// Redirect if page is out of range
if (currentPage > totalPages && totalPages > 0) {
  return Astro.redirect('/blog/');
}

// Generate page numbers to show
function getVisiblePages(current: number, total: number) {
  const pages: number[] = [];

  if (total <= 7) {
    // Show all pages if 7 or fewer
    for (let i = 1; i <= total; i++) {
      pages.push(i);
    }
  } else {
    // Always show first page
    pages.push(1);

    // Show ellipsis if needed
    if (current > 3) {
      pages.push(-1); // -1 represents ellipsis
    }

    // Show pages around current
    const start = Math.max(2, current - 1);
    const end = Math.min(total - 1, current + 1);

    for (let i = start; i <= end; i++) {
      pages.push(i);
    }

    // Show ellipsis if needed
    if (current < total - 2) {
      pages.push(-1); // -1 represents ellipsis
    }

    // Always show last page
    pages.push(total);
  }

  return pages;
}

const visiblePages = getVisiblePages(currentPage, totalPages);
---

<Layout
  head={{
    title: currentCategory ? `${currentCategory} - ${AppConfig.title}` : `Blog - ${AppConfig.title}`,
    description: AppConfig.description
  }}
>
  <Section>
    <div class="py-12">
      <h1 class="mb-8 text-4xl font-bold">
        {currentCategory ? `${currentCategory} Posts` : 'All Posts'}
      </h1>
      <p class="mb-12 text-lg text-gray-600 dark:text-gray-400">
        {currentCategory
          ? `Showing ${startIndex + 1}-${Math.min(endIndex, filteredPosts.length)} of ${filteredPosts.length} posts in ${currentCategory}`
          : `Showing ${startIndex + 1}-${Math.min(endIndex, filteredPosts.length)} of ${allPosts.length} posts`
        }
      </p>

      <!-- Category Filter -->
      <div class="mb-8 flex flex-wrap gap-2">
        <a
          href="/blog/"
          class:font-bold={!currentCategory}
          class="rounded-full bg-stone-200 px-4 py-2 text-sm font-semibold text-stone-800 hover:bg-stone-300 dark:bg-stone-700 dark:text-stone-200 dark:hover:bg-stone-600"
        >
          All
        </a>
        {categories.map((cat) => (
          <a
            href={`/blog/category/${encodeURIComponent(cat || '')}`}
            class="rounded-full bg-stone-200 px-4 py-2 text-sm font-semibold text-stone-800 hover:bg-stone-300 dark:bg-stone-700 dark:text-stone-200 dark:hover:bg-stone-600"
          >
            {cat}
          </a>
        ))}
      </div>

      <!-- Posts Grid - 2x2 layout -->
      <div class="grid grid-cols-1 gap-6 md:grid-cols-2 mb-12">
        {currentPosts.map((post) => (
          <div>
            <Card post={post} />
          </div>
        ))}
      </div>

      <!-- Pagination -->
      {totalPages > 1 && (
        <div class="flex justify-center items-center gap-2">
          {currentPage > 1 && (
            <a
              href={currentPage === 2
                ? `/blog/${currentCategory ? `?category=${encodeURIComponent(currentCategory)}` : ''}`
                : `/blog/${currentPage - 1}${currentCategory ? `?category=${encodeURIComponent(currentCategory)}` : ''}`}
              class="rounded-lg bg-stone-200 px-4 py-2 text-sm font-semibold text-stone-800 hover:bg-stone-300 dark:bg-stone-700 dark:text-stone-200 dark:hover:bg-stone-600"
            >
              ← Previous
            </a>
          )}

          {visiblePages.map((pageNum) => {
            if (pageNum === -1) {
              return <span class="text-gray-500">...</span>;
            }

            // Page 1 should link to /blog/ instead of /blog/1
            const pageUrl = pageNum === 1
              ? `/blog/${currentCategory ? `?category=${encodeURIComponent(currentCategory)}` : ''}`
              : `/blog/${pageNum}${currentCategory ? `?category=${encodeURIComponent(currentCategory)}` : ''}`;

            return (
              <a
                href={pageUrl}
                class:font-bold={pageNum === currentPage}
                class={`rounded-lg px-4 py-2 text-sm font-semibold ${
                  pageNum === currentPage
                    ? 'bg-stone-900 text-stone-100 dark:bg-stone-100 dark:text-stone-900'
                    : 'bg-stone-200 text-stone-800 hover:bg-stone-300 dark:bg-stone-700 dark:text-stone-200 dark:hover:bg-stone-600'
                }`}
              >
                {pageNum}
              </a>
            );
          })}

          {currentPage < totalPages && (
            <a
              href={`/blog/${currentPage + 1}${currentCategory ? `?category=${encodeURIComponent(currentCategory)}` : ''}`}
              class="rounded-lg bg-stone-200 px-4 py-2 text-sm font-semibold text-stone-800 hover:bg-stone-300 dark:bg-stone-700 dark:text-stone-200 dark:hover:bg-stone-600"
            >
              Next →
            </a>
          )}
        </div>
      )}
    </div>
  </Section>
</Layout>